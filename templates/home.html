
<!DOCTYPE html>
<html>
<head>
    <title>Family Tree</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }

        .node text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }

        .node image {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Family Tree</h1>
    <a href="{% url 'tree:add_person' %}">Add Person</a>
    <div id="tree"></div>
    

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            fetch('/api/persons/')
                .then(response => response.json())
                .then(data => {
                    const treeData = convertToTree(data);
                    renderTree(treeData);
                });

                function convertToTree(data) {
                    let map = {};
                    data.forEach(person => {
                        map[person.id] = {...person, children: [], spouse: null, spouseNode: null };
                    });
                    let treeData = null;
                    data.forEach(person => {
                        if (person.parent_id === null) {
                            treeData = map[person.id];
                        } else {
                            map[person.parent_id].children.push(map[person.id]);
                        }
                        if (person.spouse_id!== null) {
                            const spouse = map[person.spouse_id];
                            if (!spouse.parent) {
                                spouse.parent = person;
                            }
                            if (!person.spouseNode) {
                                person.spouseNode = spouse;
                            }
                           
                            if (!person.children) {
                                person.children = [];
                            }
                            person.children.push(spouse);
                        }
                    });
                    return treeData;
                }

                function renderTree(data) {
                    const svg = d3.select("#tree").append("svg")
                       .attr("width", 960)
                       .attr("height", 600),
                        g = svg.append("g").attr("transform", "translate(40,0)");
                
                    const tree = d3.tree().size([960, 500]);
                
                    const root = d3.hierarchy(data);
                
                    tree(root);
                
                    const link = g.selectAll(".link")
                       .data(root.descendants().slice(1))
                       .enter().append("path")
                       .attr("class", "link")
                       .attr("d", d => `
                            M${d.y},${d.x}
                            C${(d.y + d.parent.y) / 2},${d.x}
                             ${(d.y + d.parent.y) / 2},${d.parent.x}
                             ${d.parent.y},${d.parent.x}
                        `);
                
                    const node = g.selectAll(".node")
                       .data(root.descendants())
                       .enter().append("g")
                       .attr("class", d => "node" + (d.children? " node--internal" : " node--leaf"))
                       .attr("transform", d => `translate(${d.y},${d.x})`);
                
                    node.append("circle")
                       .attr("r", 10);
                
                    node.append("image")
                       .attr("xlink:href", d => d.data.image_url)
                       .attr("x", -25)
                       .attr("y", -25)
                       .attr("width", 50)
                       .attr("height", 50);
                
                    node.append("text")
                       .attr("dy", ".35em")
                       .attr("x", d => d.children? -13 : 13)
                       .style("text-anchor", d => d.children? "end" : "start")
                       .text(d => d.data.name);
                
                    
                    const spouseLink = g.selectAll(".spouse-link")
                       .data(root.descendants().filter(d => d.data.spouseNode!== null))
                       .enter().append("path")
                       .attr("class", "spouse-link")
                       .attr("d", d => `
                            M${d.y},${d.x}
                            C${(d.y + d.data.spouseNode.y) / 2},${d.x}
                             ${(d.y + d.data.spouseNode.y) / 2},${d.data.spouseNode.x}
                             ${d.data.spouseNode.y},${d.data.spouseNode.x}
                        `);
                }
        });
    </script>
</body>
</html>